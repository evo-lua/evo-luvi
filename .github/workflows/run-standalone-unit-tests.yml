name: Standalone Unit Tests

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
  create:
    # Any branch or tag

jobs:
  build:
    name: Test Lua modules
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Fetch latest evo version tag
        # This seems like a hacky way of getting the tag, but I haven't found a better one that "just works"
        run: curl --location --silent --head --output curl.log -w %{url_effective} https://github.com/evo-lua/evo/releases/latest | grep --only-matching tag/.* | cut -f2- -d/ | tee LATEST_EVO_VERSION && cat curl.log # Print everything, for easier debugging

      - name: Download evo release # Could use any other Lua runtime, but we want the builtin testing primitives to make testing easier
        run: curl --location --silent --fail --output evo https://github.com/evo-lua/evo/releases/download/$(cat LATEST_EVO_VERSION)/evo-linux-amd64 && ls && chmod +x evo && ./evo # Output version to allow troubleshooting issues more easily if it's wrong

      - name: Run unit tests
        run: ./evo test.lua